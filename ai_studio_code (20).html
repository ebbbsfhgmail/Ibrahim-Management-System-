<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªÙŠØ¨Ø©</title>
    <style>
        /* --- General Styles & Reset --- */
        :root {
            --primary-color: #2c3e50; /* Dark Slate Blue */
            --secondary-color: #34495e; /* Wet Asphalt */
            --background-color: #ecf0f1; /* Clouds */
            --text-color: #2c3e50;
            --header-bg: #2c3e50;
            --header-text: #ecf0f1;
            --sidebar-bg: #34495e;
            --sidebar-text: #ecf0f1;
            --sidebar-hover-bg: #46627f;
            --button-bg: #27ae60; /* Nephritis */
            --button-hover-bg: #2ecc71; /* Emerald */
            --danger-button-bg: #c0392b; /* Pomegranate */
            --danger-button-hover-bg: #e74c3c; /* Alizarin */
            --input-border: #bdc3c7; /* Silver */
            --card-bg: #ffffff;
            --font-size: 16px;
        }

        .dark-mode {
            --primary-color: #bdc3c7;
            --secondary-color: #34495e;
            --background-color: #2c3e50;
            --text-color: #ecf0f1;
            --header-bg: #34495e;
            --header-text: #ecf0f1;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover-bg: #4a627a;
            --button-bg: #27ae60;
            --button-hover-bg: #2ecc71;
            --danger-button-bg: #e74c3c;
            --danger-button-hover-bg: #c0392b;
            --input-border: #7f8c8d; /* Asbestos */
            --card-bg: #34495e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tahoma', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: var(--font-size);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* --- Main Layout --- */
        .app-container {
            display: flex;
            transition: margin-right 0.3s ease;
        }

        #main-content {
            flex-grow: 1;
            padding: 20px;
            transition: margin-right 0.3s;
            margin-right: 250px; /* Same as sidebar width */
            padding-top: 80px; /* Space for fixed header */
        }

        .sidebar.closed + #main-content {
            margin-right: 0;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 250px;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding-top: 60px; /* Space for header */
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.closed {
            right: -250px;
        }

        .sidebar-header {
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid #4a627a;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: background-color 0.3s;
            border-bottom: 1px solid #4a627a;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--sidebar-hover-bg);
        }

        .sidebar-submenu {
            list-style: none;
            padding-right: 20px;
            background-color: rgba(0,0,0,0.2);
            display: none; /* Hidden by default */
        }
        
        .sidebar-submenu.open {
            display: block;
        }

        .sidebar-submenu a {
            font-size: 0.9em;
            padding: 10px 15px;
            border: none;
        }

        /* --- Header --- */
        .header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1001;
        }

        .header-title {
            font-size: 1.5em;
        }
        
        #menu-toggle {
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 2em;
            cursor: pointer;
        }

        /* --- General UI Components --- */
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .btn {
            display: inline-block;
            background-color: var(--button-bg);
            color: #fff !important;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s;
            margin: 5px;
            width: auto; /* Default width */
        }

        .btn-large {
             width: 100%;
             padding: 15px;
             margin-bottom: 10px;
        }
        
        .btn-danger {
            background-color: var(--danger-button-bg);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
        }
        
        .btn:hover {
            background-color: var(--button-hover-bg);
        }

        .btn-danger:hover {
            background-color: var(--danger-button-hover-bg);
        }

        .btn-secondary:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1em;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(44, 62, 80, 0.5);
        }
        
        select.form-control {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            background-size: 16px 12px;
            padding-right: 1rem;
        }
        
        .dark-mode select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ecf0f1' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex-grow: 1;
            margin-left: 10px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--input-border);
        }

        thead th {
            background-color: var(--secondary-color);
            color: var(--sidebar-text);
            font-weight: bold;
        }

        tbody tr:hover {
            background-color: rgba(52, 73, 94, 0.2);
        }
        
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6);
            padding-top: 60px;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 700px;
            border-radius: 10px;
            animation: slideIn 0.4s;
        }

        @keyframes slideIn {
             from {transform: translateY(-50px); opacity: 0;}
             to {transform: translateY(0); opacity: 1;}
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--input-border);
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5em;
            color: var(--primary-color);
        }

        .close-btn {
            color: var(--danger-button-bg);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-btn:hover, .close-btn:focus {
            color: var(--danger-button-hover-bg);
            text-decoration: none;
        }

        /* --- Utility Classes --- */
        .text-center { text-align: center; }
        .mt-2 { margin-top: 2rem; }
        .mb-2 { margin-bottom: 2rem; }
        .hidden { display: none; }
        
        /* --- Print Specific Styles --- */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            body {
                background-color: #fff !important;
                color: #000 !important;
                font-size: 12pt;
                direction: rtl;
            }
            .card {
                box-shadow: none;
                border: 1px solid #000;
                padding: 10px;
                background-color: #fff !important;
                color: #000 !important;
            }
            .card-header {
                color: #000 !important;
                border-bottom: 2px solid #000;
            }
            .btn { display: none; }
            table { font-size: 10pt; color: #000 !important; }
            th, td { border-bottom: 1px solid #000; color: #000 !important; }
            thead th {
                background-color: #ccc !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact; 
                color-adjust: exact;
            }
            .header, .sidebar { display: none; }
            #main-content { margin-right: 0 !important; padding: 0; padding-top: 0 !important; }
            .page.active { display: block; }
            .permit-body .fill-in {
                color: #000 !important;
                border-bottom: 1px dotted #000 !important;
            }
            .signature-pad-container { border: 1px solid #000 !important; }
        }
        
        /* --- Specific Page Styles --- */
        
        /* Home Page Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .stat-card {
            background-color: var(--secondary-color);
            color: var(--sidebar-text);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 { margin-bottom: 10px; font-size: 1.2em; }
        .stat-card .stat-number { font-size: 2.5em; font-weight: bold; }

        /* Personnel List */
        .personnel-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .personnel-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--input-border);
        }
        .personnel-card:last-child { border-bottom: none; }
        .personnel-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 15px;
            border: 2px solid var(--secondary-color);
            background-color: var(--background-color);
        }
        .personnel-info { flex-grow: 1; }
        .personnel-info h4 { margin: 0; font-size: 1.1em; }
        .personnel-info p { margin: 2px 0; color: #7f8c8d; }
        .dark-mode .personnel-info p { color: #bdc3c7; }
        .personnel-card-actions .btn { padding: 5px 10px; font-size: 0.8em; margin: 2px; }
        
        /* Attendance Page */
        .attendance-table td { text-align: center; vertical-align: middle; }
        .attendance-table .personnel-name { text-align: right; font-weight: bold; }
        .status-select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--input-border);
            background-color: var(--card-bg);
            color: var(--text-color);
            min-width: 120px;
        }
        .status-select-Ø­Ø§Ø¶Ø± { background-color: rgba(39, 174, 96, 0.1); }
        .status-select-ØºØ§Ø¦Ø¨ { background-color: rgba(192, 57, 43, 0.1); }
        .status-select-Ù…Ø±ÙŠØ¶ { background-color: rgba(241, 196, 15, 0.1); }
        .status-select-Ø±Ø§Ø­Ø© { background-color: rgba(52, 152, 219, 0.1); }
        .status-select-Ù…Ù‡Ù…Ø© { background-color: rgba(155, 89, 182, 0.1); }
        .status-select-Ø¥Ø¬Ø§Ø²Ø© { background-color: rgba(230, 126, 34, 0.1); }
        
        /* Permit Page & Signature Pad */
        .permit-container {
            border: 2px solid var(--text-color);
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            background-color: var(--card-bg);
        }
        .permit-header { text-align: center; margin-bottom: 30px; }
        .permit-header h2 { margin: 0; font-size: 1.8em; }
        .permit-header h3 { margin: 5px 0; font-size: 1.4em; }
        .permit-body { line-height: 2.2; font-size: 1.2em; }
        .permit-body .fill-in {
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
            border-bottom: 1px dotted var(--text-color);
            padding: 0 5px;
            text-align: center;
        }
        .permit-footer { margin-top: 40px; display: flex; justify-content: space-around; text-align: center; }
        .signature-block { display: flex; flex-direction: column; align-items: center; }
        .signature-block strong { margin-bottom: 10px; cursor: text; }
        .signature-pad-container {
            width: 250px;
            height: 120px;
            border: 2px dashed var(--input-border);
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: crosshair;
        }
        .signature-canvas { width: 100%; height: 100%; }
        .btn-clear-signature {
            padding: 5px 10px;
            font-size: 0.8em;
            background-color: var(--danger-button-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-clear-signature:hover { background-color: var(--danger-button-hover-bg); }
        
        /* Settings Page */
        .settings-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--input-border);
        }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px;
            left: 4px; bottom: 4px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--button-bg); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: var(--primary-color);
            color: #fff; text-align: center; border-radius: 5px; padding: 16px;
            position: fixed; z-index: 3000; left: 50%; transform: translateX(-50%);
            bottom: 30px; font-size: 17px;
        }
        #toast.show {
            visibility: visible;
            animation: toast-fadein 0.5s, toast-fadeout 0.5s 2.5s;
        }
        @keyframes toast-fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes toast-fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <div class="app-container">

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªÙŠØ¨Ø©
                <br>
                <small style="font-weight:normal;">ØªØµÙ…ÙŠÙ…: Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…</small>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#home" class="nav-link active">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="#personnel" id="personnel-menu-toggle" class="nav-link">ğŸ§‘â€âœˆï¸ Ø£ÙØ±Ø§Ø¯ Ø§Ù„ÙƒØªÙŠØ¨Ø©</a></li>
                <ul class="sidebar-submenu" id="personnel-submenu">
                   <li><a href="#all-personnel" class="nav-link" data-company="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a></li>
                </ul>
                <li><a href="#attendance" class="nav-link">â±ï¸ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</a></li>
                <li><a href="#permits" class="nav-link">ğŸ« Ø§Ù„ØªØµØ§Ø±ÙŠØ­</a></li>
                <li><a href="#reports" class="nav-link">ğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
                <li><a href="#notepad" class="nav-link">ğŸ“ Ù…Ø¯ÙˆÙ†Ø© ÙŠØ¯ÙˆÙŠØ©</a></li>
                <li><a href="#settings" class="nav-link">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
            </ul>
        </aside>

        <main id="main-content">
            <header class="header no-print">
                <button id="menu-toggle">â˜°</button>
                <h1 id="page-title" class="header-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
                <div class="header-actions"></div>
            </header>

            <!-- ======================= HOME PAGE ======================= -->
            <div id="home" class="page active">
                <div class="card">
                    <div class="card-header">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙØ±Ø§Ø¯</h3>
                            <p class="stat-number" id="total-personnel-stat">0</p>
                        </div>
                        <div class="stat-card" style="background-color: #27ae60;">
                            <h3>Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</h3>
                            <p class="stat-number" id="present-stat">0</p>
                        </div>
                        <div class="stat-card" style="background-color: #c0392b;">
                            <h3>Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</h3>
                            <p class="stat-number" id="absent-stat">0</p>
                        </div>
                        <div class="stat-card" style="background-color: #f39c12;">
                            <h3>Ø­Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰</h3>
                            <p class="stat-number" id="other-stat">0</p>
                        </div>
                    </div>
                </div>
                 <div class="card">
                    <div class="card-header">ÙˆØµÙˆÙ„ Ø³Ø±ÙŠØ¹</div>
                     <button class="btn btn-large" onclick="app.navigateTo('add-personnel-page')">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                     <button class="btn btn-large btn-secondary" onclick="app.navigateTo('attendance')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
                     <button class="btn btn-large" onclick="app.navigateTo('permits')">Ø¥Ù†Ø´Ø§Ø¡ ØªØµØ±ÙŠØ­ Ø¬Ø¯ÙŠØ¯</button>
                </div>
            </div>

            <!-- ======================= PERSONNEL PAGE ======================= -->
            <div id="all-personnel" class="page">
                <div class="personnel-actions card no-print">
                    <div>
                        <h2 id="personnel-list-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙØ±Ø§Ø¯</h2>
                    </div>
                    <button class="btn" onclick="app.showPersonnelModal()">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div class="card no-print">
                     <div class="search-bar">
                        <input type="text" id="searchInput" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ...">
                        <button class="btn btn-secondary" onclick="app.filterPersonnel()">Ø¨Ø­Ø«</button>
                     </div>
                </div>
                <div id="personnel-list-container">
                    <p class="text-center card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙØ±Ø§Ø¯ Ù„Ø¹Ø±Ø¶Ù‡Ù…. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯.</p>
                </div>
            </div>

            <!-- ======================= ATTENDANCE PAGE ======================= -->
            <div id="attendance" class="page">
                 <div class="card">
                    <div class="card-header">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
                    <div class="form-group">
                        <label for="attendance-date">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                        <input type="date" id="attendance-date" class="form-control" onchange="app.renderAttendanceTable()">
                    </div>
                    <div class="form-group">
                        <label for="attendance-company-filter">ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„Ø³Ø±ÙŠØ©:</label>
                        <select id="attendance-company-filter" class="form-control" onchange="app.renderAttendanceTable()">
                            <option value="all">ÙƒÙ„ Ø§Ù„ÙƒØªÙŠØ¨Ø©</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table class="attendance-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-list">
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 text-center no-print">
                        <button class="btn" onclick="app.saveAttendance()">Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
                        <button class="btn btn-secondary" onclick="app.generateDailyReportFromAttendance()">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
                    </div>
                </div>
            </div>

            <!-- ======================= PERMITS PAGE ======================= -->
            <div id="permits" class="page">
                 <div class="card no-print">
                    <div class="card-header">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµØ§Ø±ÙŠØ­</div>
                    <div class="form-group">
                         <label for="permit-type">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±ÙŠØ­:</label>
                         <select id="permit-type" class="form-control" onchange="app.generatePermitTemplate()">
                            <option value="">-- Ø§Ø®ØªØ± --</option>
                            <option value="raha">ØªØµØ±ÙŠØ­ Ø±Ø§Ø­Ø©</option>
                            <option value="mabeet">ØªØµØ±ÙŠØ­ Ù…Ø¨ÙŠØª</option>
                            <option value="mohema">ØªØµØ±ÙŠØ­ Ù…Ù‡Ù…Ø© Ø±Ø³Ù…ÙŠØ©</option>
                            <option value="khurooj">ØªØµØ±ÙŠØ­ Ø®Ø±ÙˆØ¬</option>
                            <option value="maradhi">Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©</option>
                         </select>
                    </div>
                     <div class="form-group">
                         <label for="permit-personnel-select">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¯ (Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹):</label>
                         <select id="permit-personnel-select" class="form-control" onchange="app.fillPermitWithPersonnelData()">
                             <option value="">-- Ø§Ø®ØªØ± ÙØ±Ø¯ --</option>
                         </select>
                     </div>
                 </div>

                <div id="permit-display-area" class="print-area">
                    <p class="text-center">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±ÙŠØ­ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‡Ù†Ø§.</p>
                </div>
                
                <div id="permit-actions" class="text-center mt-2 no-print hidden">
                    <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button class="btn btn-secondary" onclick="app.shareElementAsImage('permit-display-area', 'ØªØµØ±ÙŠØ­', 'ØªØµØ±ÙŠØ­ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©')">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                    <button class="btn btn-danger" onclick="app.clearPermit()">Ù…Ø³Ø­ Ø§Ù„ØªØµØ±ÙŠØ­</button>
                </div>
            </div>

            <!-- ======================= REPORTS PAGE ======================= -->
            <div id="reports" class="page">
                 <div class="card no-print">
                    <div class="card-header">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
                    <p>Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙŠØ¨Ø© ÙˆØ§Ù„Ø³Ø±Ø§ÙŠØ§.</p>
                     <div class="mt-2">
                        <button class="btn btn-large" onclick="app.generateDailyReport()">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
                     </div>
                </div>
                <div id="report-display-area" class="card print-area">
                    <p class="text-center">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±" Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‡Ù†Ø§.</p>
                </div>
                <div id="report-actions" class="text-center mt-2 no-print hidden">
                     <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                    <button class="btn btn-secondary" onclick="app.shareElementAsImage('report-display-area', 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ÙƒØªÙŠØ¨Ø©', 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØªÙŠØ¨Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠ')">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                </div>
            </div>
            
            <!-- ======================= NOTEPAD PAGE ======================= -->
            <div id="notepad" class="page">
                <div class="card">
                    <div class="card-header">Ù…Ø¯ÙˆÙ†Ø© ÙŠØ¯ÙˆÙŠØ©</div>
                     <p>Ù…ÙƒØ§Ù† Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©ØŒ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø£Ùˆ Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ­ØªØ§Ø¬Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø±. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
                    <textarea id="notepad-area" class="form-control" rows="20" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                     <div class="text-center mt-2">
                         <button class="btn" onclick="app.copyNotepad()">Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</button>
                         <button class="btn btn-danger" onclick="app.clearNotepad()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                     </div>
                </div>
            </div>

            <!-- ======================= SETTINGS PAGE ======================= -->
            <div id="settings" class="page">
                <div class="card">
                    <div class="card-header">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
                    
                    <div class="settings-section">
                        <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                        <label class="switch">
                          <input type="checkbox" id="darkModeToggle">
                          <span class="slider"></span>
                        </label>
                    </div>

                    <div class="settings-section">
                        <label for="fontSizeSlider">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
                        <input type="range" min="12" max="24" value="16" id="fontSizeSlider">
                    </div>

                </div>

                <div class="card">
                    <div class="card-header">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                    <p>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ. Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø®Ø§ØµØ© Ø¨Ùƒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§ Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ø§Ø¯Ù….</p>
                    <div class="mt-2">
                        <button class="btn" onclick="app.exportData()">ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)</button>
                        <label for="importFile" class="btn btn-secondary">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</label>
                        <input type="file" id="importFile" class="hidden" accept=".json">
                    </div>
                     <div class="mt-2">
                        <button class="btn btn-danger" onclick="app.confirmResetData()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                         <p><small>ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙØ±Ø§Ø¯ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.</small></p>
                    </div>
                </div>
                 <div class="card">
                    <div class="card-header">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø±Ø§ÙŠØ§ ÙˆØ§Ù„ÙØµØ§Ø¦Ù„</div>
                     <div class="form-group">
                         <label for="companyNameInput">Ø§Ø³Ù… Ø§Ù„Ø³Ø±ÙŠØ©/Ø§Ù„ÙØµÙŠÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                         <input type="text" id="companyNameInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø³Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ø¹Ù…">
                         <button class="btn mt-2" onclick="app.addCompany()">Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ©/ÙØµÙŠÙ„Ø©</button>
                     </div>
                     <div id="company-list-manager">
                         <h4>Ø§Ù„Ø³Ø±Ø§ÙŠØ§ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
                         <ul id="company-management-list">
                         </ul>
                     </div>
                 </div>
            </div>

            <!-- ======================= MODALS ======================= -->
            <div id="personnelModal" class="modal no-print">
                <div class="modal-content">
                    <div class="modal-header">
                         <h2 class="modal-title" id="personnelModalTitle">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
                        <span class="close-btn" onclick="app.closePersonnelModal()">&times;</span>
                    </div>
                    <form id="personnelForm">
                        <input type="hidden" id="personnelId">
                        <div class="form-group">
                            <label for="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                            <input type="text" id="fullName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="militaryNumber">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ</label>
                            <input type="text" id="militaryNumber" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="rank">Ø§Ù„Ø±ØªØ¨Ø©</label>
                            <input type="text" id="rank" list="rank-list" class="form-control">
                            <datalist id="rank-list">
                                <option value="Ø¬Ù†Ø¯ÙŠ"></option><option value="Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„"></option><option value="Ø¹Ø±ÙŠÙ"></option><option value="ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨"></option>
                                <option value="Ø±Ù‚ÙŠØ¨"></option><option value="Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„"></option><option value="Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡"></option>
                                <option value="Ù…Ù„Ø§Ø²Ù…"></option><option value="Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„"></option><option value="Ù†Ù‚ÙŠØ¨"></option>
                                <option value="Ø±Ø§Ø¦Ø¯"></option><option value="Ù…Ù‚Ø¯Ù…"></option><option value="Ø¹Ù‚ÙŠØ¯"></option><option value="Ø¹Ù…ÙŠØ¯"></option>
                            </datalist>
                        </div>
                         <div class="form-group">
                            <label for="company">Ø§Ù„Ø³Ø±ÙŠØ©/Ø§Ù„ÙØµÙŠÙ„Ø©</label>
                            <select id="company" class="form-control" required></select>
                        </div>
                        <div class="form-group">
                            <label for="dob">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
                            <input type="date" id="dob" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="bloodType">ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</label>
                            <select id="bloodType" class="form-control">
                                <option value="">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
                                <option value="A+">A+</option><option value="A-">A-</option>
                                <option value="B+">B+</option><option value="B-">B-</option>
                                <option value="AB+">AB+</option><option value="AB-">AB-</option>
                                <option value="O+">O+</option><option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="weaponName">Ø§Ù„Ø³Ù„Ø§Ø­</label>
                            <input type="text" id="weaponName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="weaponNumber">Ø±Ù‚Ù… Ø§Ù„Ø³Ù„Ø§Ø­</label>
                            <input type="text" id="weaponNumber" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="phoneNumber" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="address">Ø§Ù„Ø³ÙƒÙ†</label>
                            <input type="text" id="address" class="form-control">
                        </div>
                         <div class="form-group">
                            <label for="personnelImage">ØµÙˆØ±Ø© Ø§Ù„ÙØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="file" id="personnelImage" class="form-control" accept="image/*">
                             <small>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ±Ù†Øª.</small>
                        </div>
                        <div class="form-group">
                            <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea id="notes" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-large">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="viewPersonnelModal" class="modal">
                 <div class="modal-content print-area" id="personnel-detail-content">
                     <div class="modal-header no-print">
                         <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±Ø¯</h2>
                        <span class="close-btn" onclick="app.closeViewPersonnelModal()">&times;</span>
                    </div>
                    <div id="personnelDetailBody"></div>
                     <div class="text-center mt-2 no-print">
                         <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
                         <button class="btn btn-secondary" onclick="app.shareElementAsImage('personnel-detail-content', 'Ø¨ÙŠØ§Ù†Ø§Øª_ÙØ±Ø¯', 'Ø¨ÙŠØ§Ù†Ø§Øª ÙØ±Ø¯ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØªÙŠØ¨Ø©')">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                     </div>
                 </div>
            </div>

        </main>
    </div>
    
    <div id="toast"></div>

    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="html2canvas.min.js"></script>
    <script src="signature_pad.min.js"></script>

    <script>
    // =================================================================================
    //  Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªÙŠØ¨Ø© - Ø¥ØµØ¯Ø§Ø± Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ 2.0
    //  ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Gemini AI Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…
    //  Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ØªÙˆÙ‚ÙŠØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ù…Ø´Ø§Ø±ÙƒØ© Ø°ÙƒÙŠØ©ØŒ Ù…Ø±ÙˆÙ†Ø© ÙÙŠ Ø§Ù„ØªØµØ§Ø±ÙŠØ­ØŒ ÙˆØ¥ØµÙ„Ø§Ø­Ø§Øª.
    // =================================================================================

    const app = {
        db: {},
        signaturePads: [],
        elements: {
            sidebar: document.getElementById('sidebar'),
            mainContent: document.getElementById('main-content'),
            menuToggle: document.getElementById('menu-toggle'),
            pageTitle: document.getElementById('page-title'),
            navLinks: document.querySelectorAll('.nav-link'),
            pages: document.querySelectorAll('.page'),
            personnelModal: document.getElementById('personnelModal'),
            personnelForm: document.getElementById('personnelForm'),
            personnelListContainer: document.getElementById('personnel-list-container'),
            personnelModalTitle: document.getElementById('personnelModalTitle'),
            personnelSubmenu: document.getElementById('personnel-submenu'),
            companyNameInput: document.getElementById('companyNameInput'),
            companyManagementList: document.getElementById('company-management-list'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            fontSizeSlider: document.getElementById('fontSizeSlider'),
            searchInput: document.getElementById('searchInput'),
            viewPersonnelModal: document.getElementById('viewPersonnelModal'),
            personnelDetailBody: document.getElementById('personnelDetailBody'),
            toast: document.getElementById('toast'),
            notepadArea: document.getElementById('notepad-area'),
            importFileInput: document.getElementById('importFile'),
            attendanceDateInput: document.getElementById('attendance-date'),
            attendanceList: document.getElementById('attendance-list'),
            attendanceCompanyFilter: document.getElementById('attendance-company-filter'),
            permitDisplayArea: document.getElementById('permit-display-area'),
            permitActions: document.getElementById('permit-actions'),
            reportDisplayArea: document.getElementById('report-display-area'),
            reportActions: document.getElementById('report-actions'),
        },

        init() {
            document.addEventListener('DOMContentLoaded', () => {
                this.loadData();
                this.setupEventListeners();
                this.renderAll();
                this.applySettings();
                this.navigateTo(window.location.hash || '#home');
                console.log('Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªÙŠØ¨Ø© (Ø¥ØµØ¯Ø§Ø± Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… 2.0) Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„.');
            });
        },

        loadData() {
            const savedDB = localStorage.getItem('katibaDB');
            if (savedDB) {
                this.db = JSON.parse(savedDB);
                if (typeof this.db.attendance !== 'object' || this.db.attendance === null) this.db.attendance = {};
            } else {
                this.db = {
                    personnel: [],
                    companies: ['Ø§Ù„Ø³Ø±ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø§Ù„Ø³Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©', 'Ø³Ø±ÙŠØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©'],
                    attendance: {},
                    settings: { darkMode: false, fontSize: 16 },
                    notepad: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªÙŠØ¨Ø©!\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø© Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ¹Ø©.'
                };
            }
        },

        saveData() {
            try {
                localStorage.setItem('katibaDB', JSON.stringify(this.db));
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e);
                this.showToast('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù…ØªÙ„Ø¦Ø©.');
            }
        },

        setupEventListeners() {
            this.elements.menuToggle.addEventListener('click', () => this.toggleSidebar());

            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', (e) => this.handleNavigation(e));
            });
            
            document.getElementById('personnel-menu-toggle').addEventListener('click', (e) => {
                e.preventDefault();
                this.elements.personnelSubmenu.classList.toggle('open');
            });

            this.elements.personnelForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.savePersonnel();
            });

            this.elements.darkModeToggle.addEventListener('change', () => this.toggleDarkMode());
            this.elements.fontSizeSlider.addEventListener('input', (e) => this.changeFontSize(e.target.value));
            this.elements.searchInput.addEventListener('keyup', () => this.filterPersonnel());
            this.elements.notepadArea.addEventListener('keyup', this.saveNotepad.bind(this));
            this.elements.importFileInput.addEventListener('change', (e) => this.importData(e));
        },
        
        navigateTo(targetId) {
            targetId = targetId.startsWith('#') ? targetId.substring(1) : targetId;
            
            if (targetId === 'add-personnel-page') {
                this.showPersonnelModal();
                return;
            }
            
            const link = document.querySelector(`.nav-link[href="#${targetId}"]`) || document.querySelector(`.nav-link[data-company="${targetId}"]`);
            if (link) {
                this.handleNavigation({ target: link, preventDefault: () => {} });
            } else {
                this.handleNavigation({ target: document.querySelector('.nav-link[href="#home"]'), preventDefault: () => {} });
            }
        },

        handleNavigation(e) {
            e.preventDefault();
            const targetEl = e.target.closest('a');
            if (!targetEl) return;
            const targetId = targetEl.getAttribute('href')?.substring(1) || 'all-personnel';
            const companyFilter = targetEl.dataset.company;

            this.elements.pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(targetId);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                document.getElementById('home').classList.add('active');
            }

            document.querySelectorAll('.sidebar-menu a').forEach(link => link.classList.remove('active'));
            targetEl.classList.add('active');

            this.elements.pageTitle.textContent = targetEl.textContent.trim().replace(/^[^\s]+\s/,'');

            // Logic specific to each page
            if (targetId === 'all-personnel') this.renderPersonnelList(companyFilter || 'all');
            if (targetId === 'attendance') {
                this.elements.attendanceDateInput.valueAsDate = new Date();
                this.renderAttendanceTable();
            }
            if (targetId === 'settings') this.renderCompanyManager();
            if (targetId === 'home') this.updateDashboardStats();
            if (targetId === 'reports') {
                if (!this.elements.reportDisplayArea.querySelector('.card-header')) {
                    this.elements.reportDisplayArea.innerHTML = `<p class="text-center">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±" Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‡Ù†Ø§.</p>`;
                    this.elements.reportActions.classList.add('hidden');
                }
            }
            if(targetId === 'permits') this.clearPermit();
            
            if (window.innerWidth < 768) this.toggleSidebar(true);
        },
        
        toggleSidebar(forceClose = false) {
            this.elements.sidebar.classList.toggle('closed', forceClose);
        },

        showToast(message) {
            this.elements.toast.textContent = message;
            this.elements.toast.className = "show";
            setTimeout(() => { this.elements.toast.className = this.elements.toast.className.replace("show", ""); }, 3000);
        },
        
        // --- Personnel Management ---
        showPersonnelModal(id = null) {
            this.elements.personnelForm.reset();
            document.getElementById('personnelId').value = '';
            document.getElementById('personnelImage').value = '';
            if (id) {
                const person = this.db.personnel.find(p => p.id === id);
                if (person) {
                    this.elements.personnelModalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ±Ø¯';
                    Object.keys(person).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = person[key];
                    });
                }
            } else {
                this.elements.personnelModalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯';
            }
            this.elements.personnelModal.style.display = 'block';
        },

        closePersonnelModal() { this.elements.personnelModal.style.display = 'none'; },

        async savePersonnel() {
            const id = document.getElementById('personnelId').value;
            const imageFile = document.getElementById('personnelImage').files[0];
            let imageBase64 = null;

            if (imageFile) {
                try {
                    imageBase64 = await this.readFileAsBase64(imageFile);
                } catch (error) {
                    this.showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø©.'); return;
                }
            }

            const personData = {
                fullName: document.getElementById('fullName').value.trim(),
                militaryNumber: document.getElementById('militaryNumber').value.trim(),
                rank: document.getElementById('rank').value.trim(),
                company: document.getElementById('company').value,
                dob: document.getElementById('dob').value,
                bloodType: document.getElementById('bloodType').value,
                weaponName: document.getElementById('weaponName').value.trim(),
                weaponNumber: document.getElementById('weaponNumber').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                address: document.getElementById('address').value.trim(),
                notes: document.getElementById('notes').value.trim(),
            };

            if (!personData.fullName || !personData.militaryNumber) {
                this.showToast('Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ Ø­Ù‚ÙˆÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©.'); return;
            }

            if (id) {
                const index = this.db.personnel.findIndex(p => p.id === id);
                if (index > -1) {
                    this.db.personnel[index] = { ...this.db.personnel[index], ...personData };
                    if (imageBase64) this.db.personnel[index].image = imageBase64;
                }
            } else {
                personData.id = `p_${Date.now()}`;
                if (imageBase64) personData.image = imageBase64;
                this.db.personnel.push(personData);
            }

            this.saveData();
            this.renderPersonnelList();
            this.updateSelects();
            this.updateDashboardStats();
            this.closePersonnelModal();
            this.showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
        },
        
        readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        },

        deletePersonnel(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¯ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                this.db.personnel = this.db.personnel.filter(p => p.id !== id);
                Object.keys(this.db.attendance).forEach(date => delete this.db.attendance[date][id]);
                this.saveData();
                this.renderPersonnelList();
                this.updateSelects();
                this.updateDashboardStats();
                this.showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ±Ø¯.');
            }
        },
        
        viewPersonnel(id) {
            const person = this.db.personnel.find(p => p.id === id);
            if (!person) return;
            const defaultImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2EwYTBhMCI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgM2MxLjY2IDAgMyAxLjM0IDMgM3MtMS4zNCAzLTMgMy0zLTEuMzQtMy0zIDEuMzQtMyAzLTN6bTAgMTRjLTIuMzMgMC00LjMyLTEuMDYtNS42OC0yLjc4Ljc3LTEuNDggMy4wNS0yLjUyIDUuNjgtMi41MiAxLjI5IDAgMi41Mi4zNCAzLjU2Ljk1LS44NS42Ny0xLjkyIDEuMDUtMy4wNiAxLjM1eiIvPjwvc3ZnPg==';
            this.elements.personnelDetailBody.innerHTML = `
                <div style="text-align:center; margin-bottom: 20px;"><h2>Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙØ±Ø¯</h2></div>
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 20px; border-bottom: 1px solid var(--input-border); padding-bottom: 20px;">
                    <img src="${person.image || defaultImg}" alt="ØµÙˆØ±Ø© Ø§Ù„ÙØ±Ø¯" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--secondary-color);">
                    <div style="flex-grow: 1;">
                        <h3 style="color: var(--primary-color); margin: 0; font-size: 1.4em;">${person.rank || ''} / ${person.fullName}</h3>
                        <p><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ:</strong> ${person.militaryNumber}</p>
                    </div>
                </div>
                <table style="width:100%; text-align: right; border-collapse: collapse; margin-top: 15px;">
                    <tr><td style="padding: 8px; border-bottom: 1px solid var(--input-border);"><strong>Ø§Ù„Ø³Ø±ÙŠØ©/Ø§Ù„ÙØµÙŠÙ„Ø©:</strong></td><td style="padding: 8px; border-bottom: 1px solid var(--input-border);">${person.company || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
                    <tr><td style="padding: 8px; border-bottom: 1px solid var(--input-border);"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</strong></td><td style="padding: 8px; border-bottom: 1px solid var(--input-border);">${person.dob || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
                    <tr><td style="padding: 8px; border-bottom: 1px solid var(--input-border);"><strong>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…:</strong></td><td style="padding: 8px; border-bottom: 1px solid var(--input-border);">${person.bloodType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
                    <tr><td style="padding: 8px; border-bottom: 1px solid var(--input-border);"><strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong></td><td style="padding: 8px; border-bottom: 1px solid var(--input-border);">${person.weaponName || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td></tr>
                    <tr><td style="padding: 8px; border-bottom: 1px solid var(--input-border);"><strong>Ø±Ù‚Ù… Ø§Ù„Ø³Ù„Ø§Ø­:</strong></td><td style="padding: 8px; border-bottom: 1px solid var(--input-border);">${person.weaponNumber || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td></tr>
                    <tr><td style="padding: 8px; border-bottom: 1px solid var(--input-border);"><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong></td><td style="padding: 8px; border-bottom: 1px solid var(--input-border);">${person.phoneNumber || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td></tr>
                    <tr><td style="padding: 8px; border-bottom: 1px solid var(--input-border);"><strong>Ø§Ù„Ø³ÙƒÙ†:</strong></td><td style="padding: 8px; border-bottom: 1px solid var(--input-border);">${person.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
                    <tr><td style="padding: 8px; vertical-align: top;"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong></td><td style="padding: 8px;">${person.notes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td></tr>
                </table>
            `;
            this.elements.viewPersonnelModal.style.display = 'block';
        },
        
        closeViewPersonnelModal() { this.elements.viewPersonnelModal.style.display = 'none'; },

        filterPersonnel() {
            const searchTerm = this.elements.searchInput.value.toLowerCase();
            const activeCompany = document.querySelector('.sidebar-menu a.active')?.dataset.company || 'all';
            this.renderPersonnelList(activeCompany, searchTerm);
        },
        
        // --- Attendance ---
        renderAttendanceTable() {
            const date = this.elements.attendanceDateInput.value;
            if (!date) {
                this.elements.attendanceList.innerHTML = `<tr><td colspan="3" class="text-center">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ®.</td></tr>`;
                return;
            }
            const companyFilter = this.elements.attendanceCompanyFilter.value;
            const dateKey = new Date(date).toISOString().slice(0, 10);
            let filteredPersonnel = this.db.personnel;
            if (companyFilter !== 'all') {
                filteredPersonnel = filteredPersonnel.filter(p => p.company === companyFilter);
            }
            if (filteredPersonnel.length === 0) {
                this.elements.attendanceList.innerHTML = `<tr><td colspan="3" class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙØ±Ø§Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø±ÙŠØ©.</td></tr>`;
                return;
            }
            const attendanceDataForDate = this.db.attendance[dateKey] || {};
            const statuses = ['Ø­Ø§Ø¶Ø±', 'ØºØ§Ø¦Ø¨', 'Ù…Ø±ÙŠØ¶', 'Ø±Ø§Ø­Ø©', 'Ù…Ù‡Ù…Ø©', 'Ø¥Ø¬Ø§Ø²Ø©'];
            let html = '';
            filteredPersonnel.sort((a,b) => a.fullName.localeCompare(b.fullName, 'ar')).forEach(person => {
                const personAttendance = attendanceDataForDate[person.id] || { status: 'Ø­Ø§Ø¶Ø±', notes: '' };
                const statusOptions = statuses.map(s => `<option value="${s}" ${personAttendance.status === s ? 'selected' : ''}>${s}</option>`).join('');
                html += `
                    <tr class="status-select-${personAttendance.status}">
                        <td class="personnel-name">${person.rank || ''} / ${person.fullName}</td>
                        <td>
                            <select class="status-select form-control" data-person-id="${person.id}" onchange="this.parentElement.parentElement.className='status-select-' + this.value">${statusOptions}</select>
                        </td>
                        <td><input type="text" class="form-control" value="${personAttendance.notes || ''}" data-person-id="${person.id}" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø©..."></td>
                    </tr>
                `;
            });
            this.elements.attendanceList.innerHTML = html;
        },

        saveAttendance() {
            const date = this.elements.attendanceDateInput.value;
            if (!date) {
                this.showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            const dateKey = new Date(date).toISOString().slice(0, 10);
            this.db.attendance[dateKey] = this.db.attendance[dateKey] || {};
            const statusSelects = this.elements.attendanceList.querySelectorAll('.status-select');
            statusSelects.forEach(select => {
                const personId = select.dataset.personId;
                const noteInput = select.parentElement.nextElementSibling.querySelector('input');
                this.db.attendance[dateKey][personId] = {
                    status: select.value,
                    notes: noteInput ? noteInput.value.trim() : ''
                };
            });
            this.saveData();
            this.updateDashboardStats();
            this.showToast('ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
        },

        // --- Permits & Signatures ---
        generatePermitTemplate() {
            const permitType = document.getElementById('permit-type').value;
            if (!permitType) {
                this.clearPermit(); return;
            }
            const templates = {
                raha: { title: "ØªØµØ±ÙŠØ­ Ø±Ø§Ø­Ø©", body: `ÙŠÙØµØ±Ø­ Ù„Ù€ <span class="fill-in" data-placeholder="rank"></span> / <span class="fill-in" data-placeholder="fullName"></span> ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ <span class="fill-in" data-placeholder="militaryNumber"></span> Ù…Ù† <span class="fill-in" data-placeholder="company"></span> Ø¨Ø£Ø®Ø° Ø±Ø§Ø­Ø© Ù„Ù…Ø¯Ø© <span contenteditable="true" class="fill-in">24 Ø³Ø§Ø¹Ø©</span> Ø§Ø¹ØªØ¨Ø§Ø±Ø§Ù‹ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ….` },
                mabeet: { title: "ØªØµØ±ÙŠØ­ Ù…Ø¨ÙŠØª", body: `ÙŠÙØµØ±Ø­ Ù„Ù€ <span class="fill-in" data-placeholder="rank"></span> / <span class="fill-in" data-placeholder="fullName"></span> ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ <span class="fill-in" data-placeholder="militaryNumber"></span> Ù…Ù† <span class="fill-in" data-placeholder="company"></span> Ø¨Ø§Ù„Ù…Ø¨ÙŠØª Ø®Ø§Ø±Ø¬ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù…Ø¯Ø© <span contenteditable="true" class="fill-in">Ù„ÙŠÙ„Ø© ÙˆØ§Ø­Ø¯Ø©</span>.` },
                mohema: { title: "ØªØµØ±ÙŠØ­ Ù…Ù‡Ù…Ø© Ø±Ø³Ù…ÙŠØ©", body: `Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙˆØ§Ù…Ø±ØŒ ÙŠÙØµØ±Ø­ Ù„Ù€ <span class="fill-in" data-placeholder="rank"></span> / <span class="fill-in" data-placeholder="fullName"></span> Ø¨Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ <span contenteditable="true" class="fill-in">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù‡Ù…Ø©</span> Ù„Ø¥Ù†Ø¬Ø§Ø² Ù…Ù‡Ù…Ø© Ø±Ø³Ù…ÙŠØ©ØŒ Ø¹Ù„Ù‰ Ø£Ù† ÙŠØ¹ÙˆØ¯ ÙÙˆØ± Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡Ø§.` },
                khurooj: { title: "ØªØµØ±ÙŠØ­ Ø®Ø±ÙˆØ¬", body: `ÙŠÙØµØ±Ø­ Ù„Ù€ <span class="fill-in" data-placeholder="rank"></span> / <span class="fill-in" data-placeholder="fullName"></span> Ø¨Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø© Ù„ØºØ±Ø¶ <span contenteditable="true" class="fill-in">Ø´Ø±Ø§Ø¡ Ø£ØºØ±Ø§Ø¶ Ø´Ø®ØµÙŠØ©</span> Ù„Ù…Ø¯Ø© <span contenteditable="true" class="fill-in">Ø³Ø§Ø¹ØªÙŠÙ†</span>.` },
                maradhi: { title: "Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©", body: `Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØŒ ÙŠÙÙ…Ù†Ø­ <span class="fill-in" data-placeholder="rank"></span> / <span class="fill-in" data-placeholder="fullName"></span> Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ù„Ù…Ø¯Ø© <span contenteditable="true" class="fill-in">... ÙŠÙˆÙ…</span> Ø§Ø¹ØªØ¨Ø§Ø±Ø§Ù‹ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ….` }
            };

            const template = templates[permitType];
            const html = `
                <div class="permit-container">
                    <div class="permit-header">
                        <h2>Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</h2>
                        <h3>${template.title}</h3>
                    </div>
                    <div class="permit-body">${template.body}<br><br>ÙˆØ¹Ù„ÙŠÙ‡ Ø¬Ø±Ù‰ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹.</div>
                    <div class="permit-footer">
                        <div class="signature-block">
                            <strong contenteditable="true">Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø³Ø±ÙŠØ©</strong>
                            <div class="signature-pad-container"><canvas class="signature-canvas"></canvas></div>
                            <button class="btn-clear-signature no-print">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
                        </div>
                        <div class="signature-block">
                            <strong contenteditable="true">Ø¶Ø§Ø¨Ø· Ø§Ù„Ø£Ù…Ù†</strong>
                            <div class="signature-pad-container"><canvas class="signature-canvas"></canvas></div>
                            <button class="btn-clear-signature no-print">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
                        </div>
                    </div>
                </div>`;
            this.elements.permitDisplayArea.innerHTML = html;
            this.initSignaturePads();
            this.fillPermitWithPersonnelData();
            this.elements.permitActions.classList.remove('hidden');
        },

        initSignaturePads() {
            this.signaturePads = [];
            const canvases = this.elements.permitDisplayArea.querySelectorAll('.signature-canvas');
            canvases.forEach((canvas, index) => {
                const signaturePad = new SignaturePad(canvas, { penColor: 'rgb(0, 0, 0)' });
                this.signaturePads.push(signaturePad);
                canvas.closest('.signature-block').querySelector('.btn-clear-signature').addEventListener('click', () => {
                    signaturePad.clear();
                });
            });
            // Adjust canvas size after creation
            function resizeCanvas() {
                canvases.forEach(canvas => {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                });
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
        },

        fillPermitWithPersonnelData() {
            const personId = document.getElementById('permit-personnel-select').value;
            const person = this.db.personnel.find(p => p.id === personId);
            const container = this.elements.permitDisplayArea;
            if (!container.querySelector('.permit-container')) return;
            const placeholders = {
                rank: person?.rank || '........', fullName: person?.fullName || '........',
                militaryNumber: person?.militaryNumber || '........', company: person?.company || '........'
            };
            container.querySelectorAll('.fill-in[data-placeholder]').forEach(span => {
                const key = span.dataset.placeholder;
                if (placeholders[key]) {
                    span.textContent = placeholders[key];
                    span.setAttribute('contenteditable', 'true');
                }
            });
        },

        clearPermit() {
            this.elements.permitDisplayArea.innerHTML = `<p class="text-center">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±ÙŠØ­ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‡Ù†Ø§.</p>`;
            this.elements.permitActions.classList.add('hidden');
            document.getElementById('permit-type').value = '';
            document.getElementById('permit-personnel-select').value = '';
        },
        
        // --- Reports ---
        getTodaysStats() {
            const todayKey = new Date().toISOString().slice(0, 10);
            const attendanceToday = this.db.attendance[todayKey] || {};
            const stats = {
                total: this.db.personnel.length, present: 0, absent: 0, sick: 0,
                rest: 0, mission: 0, leave: 0, other: 0,
                lists: { absent: [], sick: [], rest: [], mission: [], leave: [] }
            };
            this.db.personnel.forEach(person => {
                const personStatus = attendanceToday[person.id]?.status;
                const personName = `${person.rank || 'ÙØ±Ø¯'} / ${person.fullName}`;
                switch(personStatus) {
                    case 'Ø­Ø§Ø¶Ø±': stats.present++; break;
                    case 'Ù…Ø±ÙŠØ¶': stats.sick++; stats.lists.sick.push(personName); break;
                    case 'Ø±Ø§Ø­Ø©': stats.rest++; stats.lists.rest.push(personName); break;
                    case 'Ù…Ù‡Ù…Ø©': stats.mission++; stats.lists.mission.push(personName); break;
                    case 'Ø¥Ø¬Ø§Ø²Ø©': stats.leave++; stats.lists.leave.push(personName); break;
                    case 'ØºØ§Ø¦Ø¨': stats.absent++; stats.lists.absent.push(personName); break;
                    default: stats.absent++; stats.lists.absent.push(personName); break; // Not recorded = absent
                }
            });
            stats.other = stats.sick + stats.rest + stats.mission + stats.leave;
            return stats;
        },

        updateDashboardStats() {
            const stats = this.getTodaysStats();
            document.getElementById('total-personnel-stat').textContent = stats.total;
            document.getElementById('present-stat').textContent = stats.present;
            document.getElementById('absent-stat').textContent = stats.absent;
            document.getElementById('other-stat').textContent = stats.other;
        },

        generateDailyReport() {
            const stats = this.getTodaysStats();
            const today = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const generateList = (list) => list.length > 0 ? `<ul style="padding-right: 20px;">${list.map(name => `<li>${name}</li>`).join('')}</ul>` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯.';
            const html = `
                <div class="card-header" style="text-align:center;">Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…<br>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - ${today}</div>
                <table style="width:100%; margin-top: 15px;">
                    <tr><td style="font-weight:bold;">Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©:</td><td>${stats.total} ÙØ±Ø¯</td></tr>
                    <tr><td style="font-weight:bold;">Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„ÙŠØ§Ù‹:</td><td>${stats.present} ÙØ±Ø¯</td></tr>
                    <tr style="color: #c0392b;"><td style="font-weight:bold;">Ø§Ù„ØºÙŠØ§Ø¨:</td><td>${stats.absent} ÙØ±Ø¯</td></tr>
                    <tr><td style="font-weight:bold;">Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:</td><td>${stats.other} ÙØ±Ø¯</td></tr>
                </table>
                <hr style="margin: 15px 0;">
                <h4>ØªÙØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª:</h4>
                <p><strong>Ø§Ù„ØºÙŠØ§Ø¨ (${stats.lists.absent.length}):</strong></p>${generateList(stats.lists.absent)}
                <p><strong>Ø§Ù„Ù…Ø±Ø¶Ù‰ (${stats.lists.sick.length}):</strong></p>${generateList(stats.lists.sick)}
                <p><strong>Ø§Ù„Ø±Ø§Ø­Ø© (${stats.lists.rest.length}):</strong></p>${generateList(stats.lists.rest)}
                <p><strong>Ø§Ù„Ù…Ù‡Ù…Ø§Øª (${stats.lists.mission.length}):</strong></p>${generateList(stats.lists.mission)}
                <p><strong>Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (${stats.lists.leave.length}):</strong></p>${generateList(stats.lists.leave)}
            `;
            this.elements.reportDisplayArea.innerHTML = html;
            this.elements.reportActions.classList.remove('hidden');
            this.navigateTo('reports'); // Navigate AFTER content is set
        },
        
        generateDailyReportFromAttendance() {
            this.saveAttendance();
            this.generateDailyReport();
        },

        // --- Settings & Data Management ---
        addCompany() {
            const name = this.elements.companyNameInput.value.trim();
            if (name && !this.db.companies.includes(name)) {
                this.db.companies.push(name);
                this.saveData(); this.renderAll();
                this.elements.companyNameInput.value = '';
                this.showToast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${name}"`);
            } else { this.showToast('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­.'); }
        },
        deleteCompany(name) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${name}"ØŸ Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø±ÙŠØ© Ù…Ù† Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡Ø§.`)) {
                this.db.companies = this.db.companies.filter(c => c !== name);
                this.db.personnel.forEach(p => { if (p.company === name) p.company = ''; });
                this.saveData(); this.renderAll();
                this.showToast(`ØªÙ… Ø­Ø°Ù "${name}"`);
            }
        },
        toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            this.db.settings.darkMode = document.body.classList.contains('dark-mode');
            this.saveData();
        },
        changeFontSize(size) {
            document.body.style.setProperty('--font-size', `${size}px`);
            this.db.settings.fontSize = size;
            this.saveData();
        },
        applySettings() {
            if (this.db.settings.darkMode) {
                document.body.classList.add('dark-mode');
                this.elements.darkModeToggle.checked = true;
            }
            if (this.db.settings.fontSize) {
                document.body.style.setProperty('--font-size', `${this.db.settings.fontSize}px`);
                this.elements.fontSizeSlider.value = this.db.settings.fontSize;
            }
        },
        saveNotepad: (function() {
            let timeout;
            return function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    this.db.notepad = this.elements.notepadArea.value;
                    this.saveData();
                    this.showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
                }, 1500);
            };
        })(),
        copyNotepad() { navigator.clipboard.writeText(this.elements.notepadArea.value).then(() => this.showToast('ØªÙ… Ù†Ø³Ø® Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©.')); },
        clearNotepad() { if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©ØŸ')) { this.elements.notepadArea.value = ''; this.db.notepad = ''; this.saveData(); } },
        exportData() {
            const dataStr = JSON.stringify(this.db, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `katiba-backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            this.showToast('ØªÙ… Ø¨Ø¯Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.');
        },
        importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedDb = JSON.parse(e.target.result);
                    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
                        if (importedDb.personnel && importedDb.companies) {
                            this.db = importedDb;
                            this.saveData();
                            this.showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
                            setTimeout(() => window.location.reload(), 1500);
                        } else { throw new Error('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚.'); }
                    }
                } catch (err) { this.showToast('Ø®Ø·Ø£: ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù.'); console.error(err); }
                finally { this.elements.importFileInput.value = ''; }
            };
            reader.readAsText(file);
        },
        confirmResetData() {
            const conf = prompt('Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø§ÙƒØªØ¨ "Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„" ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡. Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ.');
            if (conf === 'Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„') {
                localStorage.removeItem('katibaDB');
                this.showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
                setTimeout(() => window.location.reload(), 1500);
            } else if (conf !== null) { this.showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø³Ø­.'); }
        },
        
        async shareElementAsImage(elementId, fileName, shareText = 'Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªÙŠØ¨Ø©') {
            const element = document.getElementById(elementId);
            if(typeof html2canvas === 'undefined' || typeof SignaturePad === 'undefined') {
                this.showToast('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©.');
                alert('ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙÙŠ html2canvas.min.js Ùˆ signature_pad.min.js ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯.');
                return;
            }
            this.showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©...');
            const originalBg = element.style.backgroundColor;
            element.style.backgroundColor = '#FFFFFF';
            const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#FFFFFF',
                onclone: (doc) => {
                    const clonedElement = doc.getElementById(elementId);
                    clonedElement.style.color = '#000000';
                    clonedElement.querySelectorAll('*').forEach(el => { el.style.color = '#000000'; });
                }
            });
            element.style.backgroundColor = originalBg;

            // Smart Share: Use Web Share API if available, otherwise fallback to download
            if (navigator.share && navigator.canShare) {
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `${fileName}.png`, { type: 'image/png' });
                    try {
                        await navigator.share({
                            title: fileName,
                            text: shareText,
                            files: [file]
                        });
                        this.showToast('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.');
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            this.showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©: ' + err.message);
                        }
                    }
                }, 'image/png');
            } else {
                // Fallback for browsers that don't support Web Share API
                const image = canvas.toDataURL("image/png", 1.0);
                const a = document.createElement('a');
                a.href = image;
                a.download = `${fileName}.png`;
                a.click();
                this.showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª.');
            }
        },

        // --- Render Functions ---
        renderAll() {
            this.renderCompanyLists();
            this.renderPersonnelList();
            this.renderCompanyManager();
            this.updateSelects();
            this.updateDashboardStats();
            this.elements.notepadArea.value = this.db.notepad || '';
        },
        renderPersonnelList(companyFilter = 'all', searchTerm = '') {
            const container = this.elements.personnelListContainer;
            let filteredPersonnel = this.db.personnel;
            if (companyFilter !== 'all') {
                filteredPersonnel = filteredPersonnel.filter(p => p.company === companyFilter);
                document.getElementById('personnel-list-title').textContent = `Ø£ÙØ±Ø§Ø¯: ${companyFilter}`;
            } else {
                 document.getElementById('personnel-list-title').textContent = `ÙƒÙ„ Ø£ÙØ±Ø§Ø¯ Ø§Ù„ÙƒØªÙŠØ¨Ø©`;
            }
            if (searchTerm) {
                searchTerm = searchTerm.toLowerCase();
                filteredPersonnel = filteredPersonnel.filter(p => p.fullName.toLowerCase().includes(searchTerm) || p.militaryNumber.includes(searchTerm));
            }
            if (filteredPersonnel.length === 0) {
                container.innerHTML = '<p class="text-center card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙØ±Ø§Ø¯ Ù„Ø¹Ø±Ø¶Ù‡Ù… ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«.</p>';
                return;
            }
            const defaultImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzgwODA4MCI+PHBhdGggZD0iTTEyIDEyYyAyLjc2IDAgNS0yLjI0IDUtNXMyLjI0LTUgNS01LTUgMi4yNC01IDUgMi4yNCA1IDUgNXptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyYzAgMS4xLjkgMiAyIDJoMTRjMS4xIDAgMi0uOSAyLTJ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+';
            container.innerHTML = filteredPersonnel.sort((a,b) => a.fullName.localeCompare(b.fullName, 'ar')).map(person => `
                <div class="personnel-card">
                    <img src="${person.image || defaultImg}" class="personnel-img" alt="ØµÙˆØ±Ø© Ø§Ù„ÙØ±Ø¯" loading="lazy">
                    <div class="personnel-info">
                        <h4>${person.rank || ''} / ${person.fullName}</h4>
                        <p>Ø±.Ø¹: ${person.militaryNumber} | Ø§Ù„Ø³Ø±ÙŠØ©: ${person.company || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                    </div>
                    <div class="personnel-card-actions">
                        <button class="btn btn-secondary" onclick="app.viewPersonnel('${person.id}')">Ø¹Ø±Ø¶</button>
                        <button class="btn" onclick="app.showPersonnelModal('${person.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-danger" onclick="app.deletePersonnel('${person.id}')">Ø­Ø°Ù</button>
                    </div>
                </div>
            `).join('');
        },
        renderCompanyLists() {
            const submenu = this.elements.personnelSubmenu;
            submenu.querySelectorAll('li:not(:first-child)').forEach(link => link.remove());
            this.db.companies.sort((a,b) => a.localeCompare(b, 'ar')).forEach(company => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#all-personnel" class="nav-link" data-company="${company}">${company}</a>`;
                submenu.appendChild(li);
            });
            // Re-attach event listeners after re-rendering
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.removeEventListener('click', this.handleNavigation); // Avoid duplicates
                link.addEventListener('click', (e) => this.handleNavigation(e));
            });
        },
        renderCompanyManager() {
            const list = this.elements.companyManagementList;
            if (this.db.companies.length === 0) { list.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø±Ø§ÙŠØ§ Ø­Ø§Ù„ÙŠØ§Ù‹.</li>'; return; }
            list.innerHTML = this.db.companies.sort((a,b) => a.localeCompare(b, 'ar')).map(name => `
                <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--input-border);">
                    ${name}
                    <button class="btn btn-danger" style="padding: 5px 10px;" onclick="app.deleteCompany('${name}')">Ø­Ø°Ù</button>
                </li>
            `).join('');
        },
        updateSelects() {
            const companyOptions = this.db.companies.sort((a,b) => a.localeCompare(b, 'ar')).map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('company').innerHTML = `<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ø±ÙŠØ© --</option>` + companyOptions;
            this.elements.attendanceCompanyFilter.innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„ÙƒØªÙŠØ¨Ø©</option>` + companyOptions;
            const personnelOptions = this.db.personnel
                .sort((a,b) => a.fullName.localeCompare(b.fullName, 'ar'))
                .map(p => `<option value="${p.id}">${p.rank || 'ÙØ±Ø¯'} / ${p.fullName} (${p.militaryNumber})</option>`).join('');
            document.getElementById('permit-personnel-select').innerHTML = `<option value="">-- Ø§Ø®ØªØ± ÙØ±Ø¯ --</option>` + personnelOptions;
        },
    };

    app.init();
    </script>
</body>
</html>